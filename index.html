<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>8-BIT DUCK HUNT</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
  
  :root{
    --primary:#ff006e;
    --secondary:#00f5ff;
    --accent:#ffbe0b;
    --dark:#0a0e27;
    --light:#f5f5f5;
  }
  html,body{height:100%;margin:0;font-family:'Press Start 2P',cursive;background:#0a0e27;color:#f5f5f5;overflow:hidden;position:relative}
  body{display:block}
  .screen{display:none;width:100%;height:100%;position:fixed;top:0;left:0;background:#0a0e27;align-items:center;justify-content:center;z-index:100}
  .screen.active{display:flex}
  .menu-container{width:min(600px,90vw);text-align:center;border:4px solid #ff006e;background:#0a0e27;padding:40px 20px;box-shadow:0 0 30px rgba(255,0,110,0.6),inset 0 0 20px rgba(0,245,255,0.2)}
  .title{font-size:32px;color:#ffbe0b;text-shadow:3px 3px #ff006e,6px 6px #00f5ff;margin:0 0 40px 0;letter-spacing:4px}
  .menu-items{display:flex;flex-direction:column;gap:20px;margin:40px 0}
  .menu-btn{background:#ff006e;color:#0a0e27;padding:15px 30px;border:3px solid #f5f5f5;cursor:pointer;font-weight:700;font-family:'Press Start 2P',cursive;font-size:16px;text-transform:uppercase;box-shadow:4px 4px 0px #ffbe0b;transition:all 0.1s;width:100%;max-width:300px;margin:0 auto;display:block}
  .menu-btn:hover{background:#ff1493;text-shadow:0 0 10px #00f5ff}
  .menu-btn:active{transform:translate(2px,2px);box-shadow:2px 2px 0px #ffbe0b}
  .menu-footer{color:#00f5ff;font-size:12px;margin-top:40px;text-shadow:0 0 5px #ff006e;animation:blink 1s infinite}
  @keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0.3}}
  @keyframes waveScale{0%{transform:scale(0.5);opacity:0}50%{transform:scale(1.1);opacity:1}100%{transform:scale(1);opacity:1}}
  .menu-content{margin:30px 0;color:#00f5ff;font-size:12px}
  .shop-item{background:#1a1f3a;border:2px solid #00f5ff;padding:12px;margin:12px 0;color:#ffbe0b;text-shadow:0 0 5px #ff006e}
  #shopList, #ownedList{max-height:42vh;overflow:auto;padding-right:8px}
  .shop-item{display:flex;align-items:center;justify-content:space-between}
  .info-text{background:#1a1f3a;border:2px solid #00f5ff;padding:10px;margin:10px 0;color:#00f5ff;font-size:14px}
  #backFromShopBtn,#backFromExtraBtn{margin-top:30px}
  body{display:flex;align-items:center;justify-content:center}
  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(10,14,39,0.95);z-index:200;align-items:center;justify-content:center}
  .modal.active{display:flex}
  .modal-content{border:4px solid #ff006e;background:#0a0e27;padding:30px;max-width:500px;text-align:center;box-shadow:0 0 40px rgba(255,0,110,0.8),inset 0 0 20px rgba(0,245,255,0.3)}
  .modal h2{font-size:20px;color:#ffbe0b;text-shadow:2px 2px #ff006e;margin:0 0 20px 0}
  .modal-instructions{color:#00f5ff;font-size:12px;text-align:left;background:#1a1f3a;border:2px solid #00f5ff;padding:15px;margin:15px 0;line-height:1.8}
  .modal-instructions p{margin:8px 0}
  .modal button{margin-top:20px;background:#ffbe0b;color:#0a0e27;padding:12px 25px;border:3px solid #ff006e;cursor:pointer;font-weight:700;font-family:'Press Start 2P',cursive;font-size:12px;text-transform:uppercase;box-shadow:4px 4px 0px #ff006e;transition:all 0.1s}
  .modal button:hover{background:#ffd700;text-shadow:0 0 10px #ff006e}
  .modal button:active{transform:translate(2px,2px);box-shadow:2px 2px 0px #ff006e}
  .shop-btn{background:#00f5ff;color:#0a0e27;padding:8px 15px;border:2px solid #ffbe0b;cursor:pointer;font-weight:700;font-family:'Press Start 2P',cursive;font-size:10px;text-transform:uppercase;box-shadow:2px 2px 0px #ffbe0b;transition:all 0.1s;display:inline-block;margin-top:8px}
  .shop-btn:hover{background:#00fff5}
  .shop-btn:active{transform:translate(1px,1px);box-shadow:1px 1px 0px #ffbe0b}
  .wave-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(10,14,39,0.9);z-index:150;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.3s}
  .wave-overlay.show{opacity:1;pointer-events:all}
  .wave-text{font-size:64px;color:#ffbe0b;text-shadow:4px 4px #ff006e,8px 8px #00f5ff;letter-spacing:8px;animation:waveScale 2s ease-out}
  .wrap{width:min(980px,96vw);max-width:980px;padding:12px;background:#0a0e27;border:4px solid #ff006e;box-shadow:0 0 20px rgba(255,0,110,0.5)}
  header{display:flex;align-items:center;gap:12px;margin-bottom:10px;border-bottom:2px solid #00f5ff;padding-bottom:8px}
  header h1{font-size:14px;margin:0;color:#ffbe0b;text-shadow:2px 2px #ff006e;letter-spacing:2px}
  .panel{background:#0a0e27;border:2px solid #00f5ff;padding:8px;box-shadow:inset 0 0 10px rgba(0,245,255,0.2)}
  .topbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px;flex-wrap:wrap}
  .stats{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .stat{background:#0a0e27;border:1px solid #ff006e;padding:4px 8px;color:#00f5ff;font-weight:700;font-size:10px;text-shadow:0 0 4px #00f5ff}
  .btn{background:#ff006e;color:#0a0e27;padding:6px 10px;border:2px solid #f5f5f5;cursor:pointer;font-weight:700;font-family:'Press Start 2P',cursive;font-size:10px;text-transform:uppercase;box-shadow:3px 3px 0px #ffbe0b;transition:all 0.1s}
  .btn:active{transform:translate(2px,2px);box-shadow:1px 1px 0px #ffbe0b}
  canvas{display:block;width:100%;height:60vh;border:3px solid #ffbe0b;background:#1a1f3a;image-rendering:pixelated;image-rendering:crisp-edges}
  .controls{display:flex;gap:8px;align-items:center;margin-top:8px;border-top:2px solid #ff006e;padding-top:8px;flex-wrap:wrap}
  .small{font-size:8px;color:#00f5ff;text-shadow:0 0 2px #ff006e}
  footer.small{margin-top:8px;color:#ffbe0b;font-size:8px;border-top:2px solid #00f5ff;padding-top:8px;text-align:center}
  @media (max-width:600px){
    canvas{height:52vh}
    header h1{font-size:12px}
    .stat{font-size:8px}
    .small{font-size:7px}
  }
</style>
</head>
<body>
<div id="homeScreen" class="screen active">
  <div class="menu-container">
    <h1 class="title">8-BIT DUCK</h1>
    <div class="menu-items">
      <button class="menu-btn" id="playBtn">START</button>
      <button class="menu-btn" id="shopBtn">SHOP</button>
      <button class="menu-btn" id="extraBtn">EXTRA</button>
    </div>
    <div class="menu-footer">PRESS START</div>
  </div>
</div>

<div id="gameScreen" class="screen">
  <div id="waveOverlay" class="wave-overlay">
    <div class="wave-text" id="waveText">WAVE 1</div>
  </div>
  <div id="gameOverOverlay" class="wave-overlay" style="background:rgba(139,0,0,0.9);">
    <div style="text-align:center;">
      <div class="wave-text" style="color:#ff4444;margin-bottom:40px;">GAME OVER</div>
      <div style="font-size:20px;color:#ffbe0b;margin-bottom:30px;">
        <div>SCORE: <span id="gameOverScore">0</span></div>
        <div>COINS EARNED: <span id="gameOverCoins">0</span></div>
      </div>
      <div style="display:flex;gap:20px;justify-content:center;">
        <button class="menu-btn" id="retryBtn">RETRY</button>
        <button class="menu-btn" id="homeFromGameOverBtn">HOME</button>
      </div>
    </div>
  </div>
  <div id="instructionsModal" class="modal">
    <div class="modal-content">
      <h2>HOW TO PLAY</h2>
      <div class="modal-instructions">
        <p>CLICK or TAP to SHOOT</p>
        <p>PRESS SPACE to RELOAD</p>
        <p>You have LIMITED AMMO each round</p>
        <p>Ducks fly across the screen</p>
        <p>SHOOT them before they escape!</p>
        <p>Visit the SHOP to buy creative skins for ducks & backgrounds</p>
        <p>Difficulty increases each round</p>
      </div>
      <button id="startGameBtn">START GAME</button>
    </div>
  </div>
  <div class="wrap">
    <header>
      <div>
        <h1>8-BIT DUCK</h1>
      </div>
    </header>

    <div class="panel">
      <div class="topbar">
        <div class="stats">
          <div class="stat" id="ammo">AMMO:6</div>
          <div class="stat" id="duckTarget">DUCKS:0/6</div>
          <div class="stat" id="timer">TIME:30</div>
          <div class="stat" id="coins">COINS:0</div>
        </div>
        <div style="display:flex;gap:6px;align-items:center">
          <button class="btn" id="startBtn">START</button>
          <button class="btn" id="pauseBtn">PAUSE</button>
          <button class="btn" id="homeBtn">HOME</button>
        </div>
      </div>

      <canvas id="game"></canvas>

      <div class="controls">
        <div class="small">8-BIT DUCK HUNT v1.0</div>
        <div style="flex:1"></div>
        <div class="small">RETRO EDITION</div>
      </div>
    </div>

    <footer class="small">DIFFICULTY INCREASES EACH ROUND - GOOD LUCK!</footer>
  </div>
</div>

<div id="shopScreen" class="screen">
  <div class="menu-container">
    <h1 class="title">SHOP</h1>
    <div style="display:flex;gap:8px;justify-content:center;margin-bottom:12px">
      <button class="shop-btn" id="shopTabBtn">SHOP</button>
      <button class="shop-btn" id="ownedTabBtn">OWNED</button>
    </div>
    <div class="menu-content">
      <div id="shopList">
        <div class="shop-item">GOLDEN DUCK SKIN - 500 COINS <button class="shop-btn" id="buyDuckBtn">BUY</button></div>
        <div class="shop-item">PIRATE DUCK SKIN - 300 COINS <button class="shop-btn" id="buyDuckPirateBtn">BUY</button></div>
        <div class="shop-item">ROBOT DUCK SKIN - 350 COINS <button class="shop-btn" id="buyDuckRobotBtn">BUY</button></div>
        <div class="shop-item">NINJA DUCK SKIN - 250 COINS <button class="shop-btn" id="buyDuckNinjaBtn">BUY</button></div>
        <div class="shop-item">ASTRONAUT DUCK SKIN - 400 COINS <button class="shop-btn" id="buyDuckAstronautBtn">BUY</button></div>
        <hr style="border-color:#00f5ff;margin:8px 0" />
        <div class="shop-item">SUNSET BACKGROUND - 300 COINS <button class="shop-btn" id="buyBgBtn">BUY</button></div>
        <div class="shop-item">NIGHT BACKGROUND - 400 COINS <button class="shop-btn" id="buySpaceBtn">BUY</button></div>
        <div class="shop-item">VOLCANO BACKGROUND - 350 COINS <button class="shop-btn" id="buyVolcanoBtn">BUY</button></div>
        <div class="shop-item">NEON CITY BACKGROUND - 300 COINS <button class="shop-btn" id="buyNeonBtn">BUY</button></div>
        <div class="shop-item">FOREST BACKGROUND - 200 COINS <button class="shop-btn" id="buyForestBtn">BUY</button></div>
      </div>

      <div id="ownedList" style="display:none">
        <div class="shop-item">Owned Duck Skins:<div id="ownedDucks"></div></div>
        <div class="shop-item">Owned Backgrounds:<div id="ownedBgs"></div></div>
        <!-- crosshairs removed -->
      </div>
    </div>
    <button class="menu-btn" id="backFromShopBtn">BACK</button>
  </div>
</div>

<div id="extraScreen" class="screen">
  <div class="menu-container">
    <h1 class="title">EXTRA</h1>
    <div class="menu-content">
      <div class="info-text">HIGHEST WAVE: <span id="highestWave">0</span></div>
      <div class="info-text">GAMES PLAYED: <span id="gamesPlayed">0</span></div>
      <div class="info-text">TOTAL DUCKS: <span id="totalDucks">0</span></div>
    </div>
    <button class="menu-btn" id="backFromExtraBtn">BACK</button>
  </div>
</div>

<script>
// ============= CONFIG =============
const CONFIG = {
  ammo: 6,
  lives: 3,
  spawnIntervalMs: 900,
  baseSpawnCount: 6,
  baseSpeed: 120,
  speedIncreasePerRound: 20,
  gravity: 220,
  fallSpeed: 60,
  roundTimeSeconds: 30,
  coinsPerDuck: 10,
  duckSkinPrice: 500,
};

// ============= AUDIO =============
class SoundManager {
  constructor() {
    this.ctx = null;
  }

  init() {
    if (!this.ctx) {
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      this.ctx = new AudioCtx();
    }
  }

  play(type, frequency = 300, duration = 0.06, volume = 0.02) {
    try {
      this.init();
      const t = this.ctx.currentTime;
      const osc = this.ctx.createOscillator();
      const gain = this.ctx.createGain();
      
      osc.connect(gain);
      gain.connect(this.ctx.destination);
      osc.type = type;
      osc.frequency.setValueAtTime(frequency, t);
      gain.gain.setValueAtTime(volume, t);
      osc.start(t);
      osc.stop(t + duration);
    } catch (e) {
      // audio unavailable
    }
  }

  playShot() {
    try {
      this.init();
      const t = this.ctx.currentTime;
      
      // Main shot sound - quick frequency drop
      const osc1 = this.ctx.createOscillator();
      const gain1 = this.ctx.createGain();
      osc1.connect(gain1);
      gain1.connect(this.ctx.destination);
      osc1.type = 'square';
      osc1.frequency.setValueAtTime(400, t);
      osc1.frequency.exponentialRampToValueAtTime(100, t + 0.05);
      gain1.gain.setValueAtTime(0.15, t);
      gain1.gain.exponentialRampToValueAtTime(0.01, t + 0.05);
      osc1.start(t);
      osc1.stop(t + 0.05);
      
      // Click/pop sound for more impact
      const osc2 = this.ctx.createOscillator();
      const gain2 = this.ctx.createGain();
      osc2.connect(gain2);
      gain2.connect(this.ctx.destination);
      osc2.type = 'square';
      osc2.frequency.setValueAtTime(800, t);
      gain2.gain.setValueAtTime(0.08, t);
      gain2.gain.exponentialRampToValueAtTime(0.01, t + 0.02);
      osc2.start(t);
      osc2.stop(t + 0.02);
    } catch (e) {}
  }

  playFall() {
    try {
      this.init();
      const t = this.ctx.currentTime;
      
      // Falling whistle
      const osc = this.ctx.createOscillator();
      const gain = this.ctx.createGain();
      osc.connect(gain);
      gain.connect(this.ctx.destination);
      osc.type = 'sine';
      osc.frequency.setValueAtTime(600, t);
      osc.frequency.exponentialRampToValueAtTime(150, t + 0.3);
      gain.gain.setValueAtTime(0.08, t);
      gain.gain.exponentialRampToValueAtTime(0, t + 0.3);
      osc.start(t);
      osc.stop(t + 0.3);
      
      // Impact thud at the end
      const osc2 = this.ctx.createOscillator();
      const gain2 = this.ctx.createGain();
      osc2.connect(gain2);
      gain2.connect(this.ctx.destination);
      osc2.type = 'square';
      osc2.frequency.setValueAtTime(100, t + 0.25);
      gain2.gain.setValueAtTime(0.1, t + 0.25);
      gain2.gain.exponentialRampToValueAtTime(0, t + 0.35);
      osc2.start(t + 0.25);
      osc2.stop(t + 0.35);
    } catch (e) {}
  }

  hit() { this.playShot(); }
  reload() { this.play('square', 400, 0.08, 0.06); this.play('square', 500, 0.08, 0.06); }
  miss() { this.play('square', 200, 0.15, 0.05); }
  gameOver() { this.play('square', 300, 0.2, 0.08); this.play('square', 200, 0.2, 0.08); }
}

// ============= DUCK CLASS =============
class Duck {
  constructor(x, y, vx, vy, size) {
    this.x = x;
    this.y = y;
    this.vx = vx;
    this.vy = vy;
    this.size = size;
    this.rotation = 0;
    this.rotSpeed = (Math.random() - 0.5) * 0.04;
    this.hit = false;
    this.landed = false;
    this.created = performance.now();
    this.points = Math.round(size);
  }

  update(dt, canvasW, canvasH) {
    if (this.hit) {
      // falling state
      this.vy += CONFIG.gravity * dt;
      this.y += this.vy * dt;
      this.x += this.vx * dt;
      this.rotation += 0.06;
      
      // play landing sound when hits ground
      if (!this.landed && this.y > canvasH + 60) {
        this.landed = true;
        if (this.soundManager) {
          this.soundManager.playFall();
        }
      }
      
      return this.y > canvasH + 60;
    } else {
      // flying state
      this.x += this.vx * dt;
      const sway = Math.sin((performance.now() - this.created) / 400) * 10 * dt;
      this.y += sway;
      this.rotation += this.rotSpeed;
      return this.x < -120 || this.x > canvasW + 120;
    }
  }

  shoot() {
    this.hit = true;
    this.vy = CONFIG.fallSpeed;
    this.vx *= 0.2;
    this.rotation = 0;
    this.y -= 6;
  }

  isPointInside(px, py) {
    const dx = px - this.x;
    const dy = py - this.y;
    const rx = this.size * 0.9;
    const ry = this.size * 0.6;
    return (dx * dx) / (rx * rx) + (dy * dy) / (ry * ry) <= 1;
  }

  draw(ctx) {
    ctx.save();
    ctx.translate(this.x, this.y);
    ctx.rotate(this.rotation);
    const s = this.size;
    const sDraw = s;
    const pixelSize = Math.max(1, Math.floor(sDraw / 4));
    
    // 8-bit pixelated duck
    const skin = (typeof game !== 'undefined') ? game.equippedSkin : null;
    // default palette
    let bodyColor = this.hit ? '#444444' : '#ff6b35';
    let headColor = this.hit ? '#333333' : '#ff8c42';
    let wingColor = this.hit ? '#222222' : '#ffa500';

    // skin overrides
    if (skin === 'gold') {
      bodyColor = '#ffd700'; headColor = '#fff176'; wingColor = '#ffd54f';
    } else if (skin === 'zombie') {
      bodyColor = '#6fbf6f'; headColor = '#b8f0b8'; wingColor = '#86d786';
    } else if (skin === 'pirate') {
      bodyColor = '#8b5a2b'; headColor = '#c78b62'; wingColor = '#7a4a24';
    } else if (skin === 'robot') {
      bodyColor = '#9ea7ad'; headColor = '#cfd6da'; wingColor = '#8b9398';
    } else if (skin === 'ninja') {
      bodyColor = '#111111'; headColor = '#222222'; wingColor = '#111111';
    // ...existing code...
    } else if (skin === 'astronaut') {
      bodyColor = '#f6f7f8'; headColor = '#e6eef5'; wingColor = '#e0e6ea';
    }

    ctx.fillStyle = bodyColor;
    // Body (pixelated)
      for (let i = 0; i < 3; i++) {
        for (let j = 0; j < 2; j++) {
          ctx.fillRect(-sDraw * 0.4 + i * pixelSize, -sDraw * 0.2 + j * pixelSize, pixelSize, pixelSize);
        }
      }

      ctx.fillStyle = headColor;
      for (let i = 0; i < 2; i++) {
        for (let j = 0; j < 2; j++) {
          ctx.fillRect(sDraw * 0.3 + i * pixelSize, -sDraw * 0.3 + j * pixelSize, pixelSize, pixelSize);
        }
      }
      // Eye (white pixel)
      ctx.fillStyle = (skin === 'ninja') ? '#222222' : '#ffffff';
      ctx.fillRect(sDraw * 0.5, -sDraw * 0.35, pixelSize * 0.8, pixelSize * 0.8);
      // Eye pupil (black) or slit
      ctx.fillStyle = '#000000';
      ctx.fillRect(sDraw * 0.55, -sDraw * 0.3, pixelSize * 0.4, pixelSize * 0.4);
    
      ctx.fillStyle = wingColor;
      for (let i = 0; i < 2; i++) {
        for (let j = 0; j < 2; j++) {
          ctx.fillRect(-sDraw * 0.2 + i * pixelSize, -sDraw * 0.1 + j * pixelSize, pixelSize, pixelSize);
        }
      }

      // ...existing code...
    // Eye (white pixel)
    ctx.fillStyle = (skin === 'ninja') ? '#222222' : '#ffffff';
    ctx.fillRect(sDraw * 0.5, -sDraw * 0.35, pixelSize * 0.8, pixelSize * 0.8);
    
    // Eye pupil (black) or slit
    ctx.fillStyle = '#000000';
    ctx.fillRect(sDraw * 0.55, -sDraw * 0.3, pixelSize * 0.4, pixelSize * 0.4);
    
    // Wing (pixelated)
    ctx.fillStyle = wingColor;
    for (let i = 0; i < 2; i++) {
      for (let j = 0; j < 2; j++) {
        ctx.fillRect(-sDraw * 0.2 + i * pixelSize, -sDraw * 0.1 + j * pixelSize, pixelSize, pixelSize);
      }
    }

    // decorations per skin
    if (skin === 'pirate') {
      // eye patch (black rectangle over eye)
      ctx.fillStyle = '#000000';
      ctx.fillRect(sDraw * 0.48, -sDraw * 0.36, pixelSize * 1.4, pixelSize * 0.9);
      // hat
      ctx.fillStyle = '#2b2b2b';
      ctx.fillRect(sDraw * 0.25, -sDraw * 0.5, pixelSize * 3, pixelSize * 0.9);
    } else if (skin === 'robot') {
      // antenna
      ctx.fillStyle = '#333333';
      ctx.fillRect(sDraw * 0.62, -sDraw * 0.55, 2, 8);
      ctx.beginPath(); ctx.fillStyle = '#ff4444'; ctx.arc(sDraw * 0.63, -sDraw * 0.6, 3, 0, Math.PI * 2); ctx.fill();
      // panel lines
      ctx.strokeStyle = '#8a8f94'; ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(-sDraw * 0.1, -sDraw * 0.05); ctx.lineTo(sDraw * 0.2, -sDraw * 0.05); ctx.stroke();
    } else if (skin === 'ninja') {
      // ninja mask band
      ctx.fillStyle = '#000000';
      ctx.fillRect(sDraw * 0.45, -sDraw * 0.38, pixelSize * 1.6, pixelSize * 0.8);
    } else if (skin === 'astronaut') {
      // helmet (circle) and visor
      ctx.beginPath(); ctx.fillStyle = '#ffffff'; ctx.arc(sDraw * 0.5, -sDraw * 0.25, pixelSize * 1.6, 0, Math.PI * 2); ctx.fill();
      ctx.beginPath(); ctx.fillStyle = '#a0c4ff'; ctx.arc(sDraw * 0.5, -sDraw * 0.25, pixelSize * 1.0, 0, Math.PI * 2); ctx.fill();
    }

    ctx.restore();
  }
}

// ============= GAME ENGINE =============
class Game {
  constructor() {
    this.canvas = document.getElementById('game');
    this.ctx = this.canvas.getContext('2d');
    this.sound = new SoundManager();

    this.running = false;
    this.paused = false;
    this.score = 0;
    this.ammo = CONFIG.ammo;
    this.round = 1;
    this.lives = CONFIG.lives;
    this.ducks = [];
    this.messages = [];
    this.totalCoins = parseInt(localStorage.getItem('duckCoins')) || 0; // persistent total coins
    this.sessionCoins = 0; // coins earned during current match only
    this.ducksHitThisRound = 0;
    this.ducksNeededThisRound = CONFIG.baseSpawnCount;
    this.roundTimeRemaining = CONFIG.roundTimeSeconds;
    this.roundStartTime = 0;

    this.mouse = { x: 0, y: 0 };
    this.lastFrame = 0;
    this.lastSpawn = 0;
    this.spawnCount = 0;
    this.duckTarget = CONFIG.baseSpawnCount;
    this.missedDucks = 0;

    this.sunHits = 0;
    this.sunX = 0;
    this.sunY = 0;
    this.duckSkinUnlocked = localStorage.getItem('duckSkinUnlocked') === 'true';
    this.equippedSkin = localStorage.getItem('duckEquipped') || null;
    this.bgEquipped = localStorage.getItem('bgEquipped') || null;

    this.setupCanvasAndUI();
    this.setupInputListeners();
  }

  setupCanvasAndUI() {
    window.addEventListener('resize', () => this.resizeCanvas());
    this.resizeCanvas();

    this.ui = {
      ammo: document.getElementById('ammo'),
      duckTarget: document.getElementById('duckTarget'),
      timer: document.getElementById('timer'),
      coins: document.getElementById('coins'),
      start: document.getElementById('startBtn'),
      pause: document.getElementById('pauseBtn'),
    };

    this.ui.start.addEventListener('click', () => this.running ? this.reset() : this.start());
    this.ui.pause.addEventListener('click', () => this.paused ? this.resume() : this.pause());
  }

  resizeCanvas() {
    const rect = this.canvas.getBoundingClientRect();
    this.canvas.width = Math.floor(rect.width * devicePixelRatio);
    this.canvas.height = Math.floor(rect.height * devicePixelRatio);
    this.ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
  }

  setupInputListeners() {
    this.canvas.addEventListener('mousemove', (e) => {
      const rect = this.canvas.getBoundingClientRect();
      this.mouse.x = e.clientX - rect.left;
      this.mouse.y = e.clientY - rect.top;
    });

    // simple click/tap controls (no burst)
    this.canvas.addEventListener('click', () => this.shoot());
    this.canvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      const touch = e.changedTouches[0];
      const rect = this.canvas.getBoundingClientRect();
      this.mouse.x = touch.clientX - rect.left;
      this.mouse.y = touch.clientY - rect.top;
      this.shoot();
    }, { passive: false });

    window.addEventListener('keydown', (e) => {
      if (e.code === 'Space') {
        e.preventDefault();
        this.reload();
      }
      if (e.code === 'KeyP' && this.running) this.paused ? this.resume() : this.pause();
    });
  }

  start() {
    this.running = true;
    this.paused = false;
    this.score = 0;
    this.ammo = CONFIG.ammo;
    this.round = 1;
    this.lives = CONFIG.lives;
    this.ducks = [];
    this.spawnCount = 0;
    this.duckTarget = CONFIG.baseSpawnCount;
    this.ducksHitThisRound = 0;
    this.ducksNeededThisRound = CONFIG.baseSpawnCount;
    this.roundTimeRemaining = CONFIG.roundTimeSeconds;
    this.sunHits = 0;
    this.duckSkinUnlocked = localStorage.getItem('duckSkinUnlocked') === 'true';
    // refresh totals and reset session coins at start
    this.totalCoins = parseInt(localStorage.getItem('duckCoins')) || 0;
    this.sessionCoins = 0;
    // load equipped items
    this.equippedSkin = localStorage.getItem('duckEquipped') || null;
    this.bgEquipped = localStorage.getItem('bgEquipped') || null;
    this.lastSpawn = performance.now();
    this.lastFrame = performance.now();
    this.roundStartTime = performance.now();
    this.ui.start.textContent = 'STOP';
    this.updateUI();
    this.showWave();
    this.draw();
    setTimeout(() => {
      requestAnimationFrame((ts) => this.tick(ts));
    }, 2500);
  }

  reset() {
    this.running = false;
    this.ducks = [];
    this.ui.start.textContent = 'Start';
    this.ui.pause.textContent = 'Pause';
    this.updateUI();
  }

  pause() {
    this.paused = true;
    this.ui.pause.textContent = 'Resume';
  }

  resume() {
    this.paused = false;
    this.ui.pause.textContent = 'Pause';
    this.lastFrame = performance.now();
  }

  shoot() {
    if (!this.running || this.paused || this.ammo <= 0) {
      if (this.ammo <= 0) this.showMessage('Reload!');
      return;
    }

    this.ammo--;
    this.updateUI();

    // check if sun was hit
    if (this.checkSunHit()) {
      this.sunHits++;
      if (this.sunHits >= 5) {
        this.triggerSunExplosion();
        return;
      }
      return;
    }

    // check hit from back to front (top to bottom draw order)
    for (let i = this.ducks.length - 1; i >= 0; i--) {
      const duck = this.ducks[i];
      if (!duck.hit && duck.isPointInside(this.mouse.x, this.mouse.y)) {
        duck.shoot();
        this.score += duck.points;
        this.sessionCoins += CONFIG.coinsPerDuck; // awarded at end of match
        this.ducksHitThisRound++;
        // persist total ducks shot
        const prevTotal = parseInt(localStorage.getItem('totalDucks')) || 0;
        localStorage.setItem('totalDucks', (prevTotal + 1).toString());
        this.sound.hit();
        this.spawnFeathers(duck.x, duck.y);
        this.sunHits = 0;
        this.updateUI();
        break;
      }
    }
  }

  // burst shot removed per user request

  checkSunHit() {
    const sunRadius = 40;
    const dx = this.mouse.x - this.sunX;
    const dy = this.mouse.y - this.sunY;
    return Math.sqrt(dx * dx + dy * dy) < sunRadius;
  }

  triggerSunExplosion() {
    this.running = false;
    this.playExplosion();
    this.showExplosionScreen();
  }

  playExplosion() {
    try {
      this.sound.init();
      const t = this.sound.ctx.currentTime;
      
      // Main explosion boom
      const osc1 = this.sound.ctx.createOscillator();
      const gain1 = this.sound.ctx.createGain();
      osc1.connect(gain1);
      gain1.connect(this.sound.ctx.destination);
      osc1.type = 'sine';
      osc1.frequency.setValueAtTime(200, t);
      osc1.frequency.exponentialRampToValueAtTime(40, t + 0.6);
      gain1.gain.setValueAtTime(0.4, t);
      gain1.gain.exponentialRampToValueAtTime(0, t + 0.6);
      osc1.start(t);
      osc1.stop(t + 0.6);
      
      // Secondary explosion crack
      const osc2 = this.sound.ctx.createOscillator();
      const gain2 = this.sound.ctx.createGain();
      osc2.connect(gain2);
      gain2.connect(this.sound.ctx.destination);
      osc2.type = 'square';
      osc2.frequency.setValueAtTime(300, t + 0.1);
      osc2.frequency.exponentialRampToValueAtTime(80, t + 0.4);
      gain2.gain.setValueAtTime(0.25, t + 0.1);
      gain2.gain.exponentialRampToValueAtTime(0, t + 0.4);
      osc2.start(t + 0.1);
      osc2.stop(t + 0.4);
      
      // High frequency sizzle
      const osc3 = this.sound.ctx.createOscillator();
      const gain3 = this.sound.ctx.createGain();
      osc3.connect(gain3);
      gain3.connect(this.sound.ctx.destination);
      osc3.type = 'square';
      osc3.frequency.setValueAtTime(800, t);
      gain3.gain.setValueAtTime(0.1, t);
      gain3.gain.exponentialRampToValueAtTime(0, t + 0.3);
      osc3.start(t);
      osc3.stop(t + 0.3);
    } catch (e) {}
  }

  showExplosionScreen() {
    const canvas = this.canvas;
    const W = canvas.width / devicePixelRatio;
    const H = canvas.height / devicePixelRatio;
    
    this.ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
    this.ctx.fillRect(0, 0, W, H);
    
    this.ctx.fillStyle = '#ffbe0b';
    this.ctx.font = 'bold 28px "Press Start 2P", cursive';
    this.ctx.textAlign = 'center';
    this.ctx.fillText('ZOMBIE DUCK', W / 2, H / 2 - 10);
    this.ctx.fillText('UNLOCKED!', W / 2, H / 2 + 30);

    // unlock zombie duck skin (no purchase required)
    localStorage.setItem('own_duck_zombie', 'true');
    
    setTimeout(() => {
      showScreen(homeScreen);
      this.reset();
    }, 3000);
  }

  reload() {
    if (this.ammo === CONFIG.ammo) return;
    this.ammo = CONFIG.ammo;
    this.sound.reload();
    this.showMessage('Reloaded!');
    this.updateUI();
  }

  spawnDuck() {
    const side = Math.random() < 0.5 ? -1 : 1;
    const x = side === -1 ? -50 : this.canvas.width / devicePixelRatio + 50;
    const y = 80 + Math.random() * (this.canvas.height / devicePixelRatio - 180);
    const baseSpeed = CONFIG.baseSpeed + (this.round - 1) * CONFIG.speedIncreasePerRound;
    const speed = baseSpeed * (0.8 + Math.random() * 0.8);
    const vx = side === -1 ? speed : -speed;
    const vy = Math.random() * 20 - 10;
    const size = 28 + Math.random() * 18;

    const duck = new Duck(x, y, vx, vy, size);
    duck.soundManager = this.sound;
    this.ducks.push(duck);
  }

  spawnFeathers(x, y) {
    for (let i = 0; i < 8; i++) {
      this.showMessage('âœ¨', x + (Math.random() - 0.5) * 20, y + (Math.random() - 0.5) * 20, 600 + Math.random() * 400, true);
    }
  }

  showMessage(text, x = null, y = null, life = 900, fade = false) {
    const W = this.canvas.width / devicePixelRatio;
    const H = this.canvas.height / devicePixelRatio;
    x ??= W / 2;
    y ??= 60 + Math.random() * 20;
    this.messages.push({ text, x, y, life, started: performance.now(), fade });
  }

  nextRound() {
    this.round++;
    // update highest wave
    const prevHigh = parseInt(localStorage.getItem('highestWave')) || 0;
    if (this.round > prevHigh) localStorage.setItem('highestWave', this.round.toString());
    this.spawnCount = 0;
    this.duckTarget = CONFIG.baseSpawnCount + (this.round - 1) * 2;
    this.ducksHitThisRound = 0;
    this.ducksNeededThisRound = this.duckTarget;
    this.roundTimeRemaining = CONFIG.roundTimeSeconds;
    this.ammo = Math.min(CONFIG.ammo + 2, this.ammo + 3);
    this.showWave();
  }

  showWave() {
    const overlay = document.getElementById('waveOverlay');
    const text = document.getElementById('waveText');
    text.textContent = `WAVE ${this.round}`;
    overlay.classList.add('show');
    setTimeout(() => {
      overlay.classList.remove('show');
    }, 2000);
  }

  endGame(missed = false) {
    this.running = false;
    this.sound.gameOver();
    this.ui.start.textContent = 'START';
    // add session earnings to persistent total and save
    const earned = this.sessionCoins;
    this.totalCoins += earned;
    this.sessionCoins = 0;
    localStorage.setItem('duckCoins', this.totalCoins.toString());
    // increment games played
    const gp = parseInt(localStorage.getItem('gamesPlayed')) || 0;
    localStorage.setItem('gamesPlayed', (gp + 1).toString());
    // ensure highest wave accounts for current round
    const prevHigh = parseInt(localStorage.getItem('highestWave')) || 0;
    if (this.round > prevHigh) localStorage.setItem('highestWave', this.round.toString());
    this.updateUI();
    this.showGameOverScreen(missed, earned);
  }

  showGameOverScreen(missed, earned) {
    document.getElementById('gameOverScore').textContent = this.score;
    document.getElementById('gameOverCoins').textContent = earned;
    const overlay = document.getElementById('gameOverOverlay');
    overlay.classList.add('show');
    // prevent interaction during overlay
    this.running = false;
  }

  tick(ts) {
    if (!this.running) return;
    if (this.paused) {
      this.lastFrame = ts;
      requestAnimationFrame((t) => this.tick(t));
      return;
    }

    const dt = Math.min(40, ts - this.lastFrame) / 1000;
    this.lastFrame = ts;

    // update timer
    this.roundTimeRemaining = Math.max(0, CONFIG.roundTimeSeconds - (performance.now() - this.roundStartTime) / 1000);
    this.updateUI();

    // check time up
    if (this.roundTimeRemaining <= 0) {
      this.endGame(false);
      return;
    }

    // spawn logic: continuously spawn ducks (no limit)
    const spawnInterval = Math.max(250, CONFIG.spawnIntervalMs - (this.round - 1) * 60);
    if (performance.now() - this.lastSpawn > spawnInterval) {
      this.spawnDuck();
      this.lastSpawn = performance.now();
      this.spawnCount++;
    }

    // update ducks
    const canvasW = this.canvas.width / devicePixelRatio;
    const canvasH = this.canvas.height / devicePixelRatio;
    for (let i = this.ducks.length - 1; i >= 0; i--) {
      if (this.ducks[i].update(dt, canvasW, canvasH)) {
        if (!this.ducks[i].hit) {
          this.sound.miss();
        }
        this.ducks.splice(i, 1);
      }
    }

    // check round complete - need to hit target before time runs out
    const allDone = this.ducksHitThisRound >= this.ducksNeededThisRound;
    if (allDone) {
      this.running = false;
      setTimeout(() => {
        this.nextRound();
        this.running = true;
        this.lastSpawn = performance.now();
        this.lastFrame = performance.now();
        this.roundStartTime = performance.now();
        setTimeout(() => {
          requestAnimationFrame((t) => this.tick(t));
        }, 2500);
      }, 500);
    }

    this.draw();
    requestAnimationFrame((t) => this.tick(t));
  }

  draw() {
    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
    this.drawBackground();

    for (const duck of this.ducks) duck.draw(this.ctx);

    this.drawMessages();
    this.drawCrosshair();
  }

  drawBackground() {
    const W = this.canvas.width / devicePixelRatio;
    const H = this.canvas.height / devicePixelRatio;

    // sky gradient - allow alternate backgrounds
    if (this.bgEquipped === 'sunset') {
      // sunset colors
      const g = this.ctx.createLinearGradient(0, 0, 0, H);
      g.addColorStop(0, '#ff9a9e');
      g.addColorStop(1, '#fad0c4');
      this.ctx.fillStyle = g;
      this.ctx.fillRect(0, 0, W, H);
    } else if (this.bgEquipped === 'night') {
      // night background
      this.ctx.fillStyle = '#000015';
      this.ctx.fillRect(0, 0, W, H);
      // stars
      this.ctx.fillStyle = '#ffffff';
      for (let i = 0; i < 120; i++) {
        const sx = (i * 97) % W;
        const sy = (i * 53) % (H * 0.6);
        this.ctx.fillRect((sx + (performance.now() / 50) % W) % W, sy, 2, 2);
      }
      // moon (now just a bright night moon)
      const moonX = W * 0.75;
      const moonY = H * 0.22;
      this.ctx.fillStyle = '#f6f7f8';
      this.ctx.beginPath();
      this.ctx.arc(moonX, moonY, 60, 0, Math.PI * 2);
      this.ctx.fill();
      // moon craters
      this.ctx.fillStyle = '#d0d0d0';
      this.ctx.fillRect(moonX - 10, moonY - 6, 8, 8);
      this.ctx.fillRect(moonX + 18, moonY + 8, 6, 6);
      this.ctx.fillRect(moonX - 28, moonY + 18, 10, 6);
    } else if (this.bgEquipped === 'neon') {
      // neon city skyline
      const g = this.ctx.createLinearGradient(0, 0, 0, H);
      g.addColorStop(0, '#070017');
      g.addColorStop(1, '#1b002b');
      this.ctx.fillStyle = g;
      this.ctx.fillRect(0, 0, W, H);

      // buildings
      for (let x = 0; x < W; x += 60) {
        const bw = 40 + (x % 3) * 10;
        const bh = 60 + ((x * 7) % (H * 0.45));
        const bx = x + (Math.sin(performance.now() / 700 + x) * 2);
        const by = H * 0.65 - bh;
        this.ctx.fillStyle = '#0b0f1a';
        this.ctx.fillRect(bx, by, bw, bh);

        // window grid with neon colors
        const cols = Math.floor(bw / 8);
        const rows = Math.floor(bh / 12);
        for (let c = 0; c < cols; c++) {
          for (let r = 0; r < rows; r++) {
            const wx = bx + 4 + c * 8;
            const wy = by + 6 + r * 12;
            // flicker based on time
            const on = Math.abs(Math.sin((performance.now() / 200) + x + c + r)) > 0.6;
            if (on) {
              const neon = ['#ff2d95','#00f5ff','#ffd700','#7c4dff'][((c + r) % 4)];
              this.ctx.fillStyle = neon;
              this.ctx.fillRect(wx, wy, 6, 8);
            } else {
              this.ctx.fillStyle = '#07101a';
              this.ctx.fillRect(wx, wy, 6, 8);
            }
          }
        }

        // neon sign
        if (x % 180 === 0) {
          this.ctx.fillStyle = '#ff2d95';
          this.ctx.fillRect(bx + 6, by + 8, 20, 6);
          this.ctx.fillStyle = '#1b002b';
          this.ctx.fillRect(bx + 8, by + 10, 16, 2);
        }
      }

      // distant stars
      this.ctx.fillStyle = '#ffffff';
      for (let i = 0; i < 40; i++) this.ctx.fillRect((i * 97) % W, (i * 29) % (H * 0.3), 2, 2);

      // street level neon glow
      this.ctx.fillStyle = 'rgba(255,45,149,0.06)';
      this.ctx.fillRect(0, H * 0.6, W, H * 0.12);

    } else if (this.bgEquipped === 'volcano') {
      // volcano background
      const g = this.ctx.createLinearGradient(0, 0, 0, H);
      g.addColorStop(0, '#2b0000');
      g.addColorStop(1, '#220400');
      this.ctx.fillStyle = g;
      this.ctx.fillRect(0, 0, W, H);

      // distant lava glow
      this.ctx.fillStyle = 'rgba(255,110,0,0.08)';
      this.ctx.fillRect(0, 0, W, H * 0.4);

      // volcano cone
      const vx = W * 0.5;
      const vy = H * 0.6;
      const coneW = 220;
      const coneH = 180;
      this.ctx.fillStyle = '#2e1a12';
      this.ctx.beginPath();
      this.ctx.moveTo(vx - coneW / 2, vy);
      this.ctx.lineTo(vx, vy - coneH);
      this.ctx.lineTo(vx + coneW / 2, vy);
      this.ctx.closePath();
      this.ctx.fill();

      // lava crack
      this.ctx.fillStyle = '#ff4500';
      this.ctx.beginPath();
      this.ctx.moveTo(vx - 10, vy - coneH * 0.2);
      this.ctx.lineTo(vx - 2, vy - coneH * 0.1);
      this.ctx.lineTo(vx, vy - coneH * 0.05 + Math.sin(performance.now() / 200) * 4);
      this.ctx.lineTo(vx + 2, vy - coneH * 0.1);
      this.ctx.lineTo(vx + 10, vy - coneH * 0.2);
      this.ctx.closePath();
      this.ctx.fill();

      // lava flow pond
      this.ctx.fillStyle = '#ff6a00';
      this.ctx.beginPath();
      this.ctx.ellipse(vx, vy + 30, 60, 18, 0, 0, Math.PI * 2);
      this.ctx.fill();

      // small sparks/embers
      for (let i = 0; i < 30; i++) {
        const ex = vx - 120 + (i * 17) % 240;
        const ey = vy - coneH - ((i * 23) % 40) - (Math.abs(Math.sin((performance.now() + i * 37) / 300)) * 20);
        this.ctx.fillStyle = 'rgba(255,180,60,0.9)';
        this.ctx.fillRect(ex, ey, 2, 2);
      }

      // ground dark
      this.ctx.fillStyle = '#1a0f0b';
      this.ctx.fillRect(0, H * 0.65, W, H * 0.35);

    } else if (this.bgEquipped === 'forest') {
      // forest background
      // sky
      const g = this.ctx.createLinearGradient(0, 0, 0, H);
      g.addColorStop(0, '#b7eaff');
      g.addColorStop(1, '#7ec850');
      this.ctx.fillStyle = g;
      this.ctx.fillRect(0, 0, W, H);

      // distant trees (dark green silhouettes)
      for (let i = 0; i < W; i += 60) {
        this.ctx.fillStyle = '#205c2a';
        this.ctx.beginPath();
        this.ctx.moveTo(i, H * 0.55);
        this.ctx.lineTo(i + 30, H * 0.35);
        this.ctx.lineTo(i + 60, H * 0.55);
        this.ctx.closePath();
        this.ctx.fill();
        // trunk
        this.ctx.fillStyle = '#6b4f1d';
        this.ctx.fillRect(i + 28, H * 0.55, 6, 20);
      }

      // midground trees (lighter green)
      for (let i = 30; i < W; i += 80) {
        this.ctx.fillStyle = '#3d7a5f';
        this.ctx.beginPath();
        this.ctx.moveTo(i, H * 0.65);
        this.ctx.lineTo(i + 40, H * 0.45);
        this.ctx.lineTo(i + 80, H * 0.65);
        this.ctx.closePath();
        this.ctx.fill();
        // trunk
        this.ctx.fillStyle = '#8d6e3a';
        this.ctx.fillRect(i + 38, H * 0.65, 8, 28);
      }

      // foreground grass
      this.ctx.fillStyle = '#2d6a4f';
      this.ctx.fillRect(0, H * 0.75, W, H * 0.25);
      // grass blades
      this.ctx.fillStyle = '#4caf50';
      for (let i = 0; i < W; i += 16) {
        this.ctx.fillRect(i, H * 0.75, 8, 18 + Math.sin(i + performance.now() / 200) * 6);
      }

      // pixel clouds
      this.ctx.fillStyle = '#ffffff';
      const cloudY = H * 0.18;
      for (let i = 0; i < 2; i++) {
        const x = (i * W / 2 + (performance.now() / 120) % W) % W;
        for (let j = 0; j < 6; j++) {
          this.ctx.fillRect(x + j * 10, cloudY + i * 40, 10, 10);
        }
      }
    } else {
      // default bright daytime
      this.ctx.fillStyle = '#87ceeb';
      this.ctx.fillRect(0, 0, W, H);

      // sun position (only in non-space backgrounds)
      this.sunX = W * 0.85;
      this.sunY = H * 0.15;

      // sun
      this.ctx.fillStyle = '#ffeb3b';
      this.ctx.beginPath();
      this.ctx.arc(this.sunX, this.sunY, 40, 0, Math.PI * 2);
      this.ctx.fill();
      
      // sun glow
      this.ctx.fillStyle = 'rgba(255, 235, 59, 0.3)';
      this.ctx.beginPath();
      this.ctx.arc(this.sunX, this.sunY, 60, 0, Math.PI * 2);
      this.ctx.fill();

      // ground (8-bit grass)
      this.ctx.fillStyle = '#2d6a4f';
      this.ctx.fillRect(0, H * 0.65, W, H * 0.35);
      
      // ground detail - grass patches
      this.ctx.fillStyle = '#3d7a5f';
      for (let i = 0; i < W; i += 40) {
        this.ctx.fillRect(i, H * 0.65, 20, 8);
      }

      // simple pixel clouds
      this.ctx.fillStyle = '#ffffff';
      const cloudY = H * 0.25;
      for (let i = 0; i < 3; i++) {
        const x = (i * W / 3 + (performance.now() / 100) % W) % W;
        for (let j = 0; j < 8; j++) {
          this.ctx.fillRect(x + j * 8, cloudY + i * 50, 8, 8);
        }
      }
    }
  }

  drawCrosshair() {
    const { x, y } = this.mouse;
    this.ctx.save();
    this.ctx.fillStyle = '#00ff00';
    // simple 8-bit crosshair
    this.ctx.fillRect(x - 12, y - 2, 24, 4);  // horizontal
    this.ctx.fillRect(x - 2, y - 12, 4, 24);  // vertical
    this.ctx.fillRect(x - 1, y - 1, 2, 2);
    this.ctx.restore();
  }

  drawMessages() {
    const now = performance.now();
    for (let i = this.messages.length - 1; i >= 0; i--) {
      const m = this.messages[i];
      const age = now - m.started;
      if (age > m.life) {
        this.messages.splice(i, 1);
        continue;
      }
      const alpha = 1 - age / m.life;
      this.ctx.save();
      this.ctx.globalAlpha = alpha;
      this.ctx.fillStyle = '#fff';
      this.ctx.font = (m.fade ? '24px' : '20px') + ' system-ui, Arial';
      this.ctx.fillText(m.text, m.x, m.y - age / 40);
      this.ctx.restore();
    }
  }

  updateUI() {
    this.ui.ammo.textContent = `AMMO:${this.ammo}`;
    this.ui.duckTarget.textContent = `DUCKS:${this.ducksHitThisRound}/${this.ducksNeededThisRound}`;
    this.ui.timer.textContent = `TIME:${Math.ceil(this.roundTimeRemaining)}`;
    // show live coins: persistent total + session earnings
    const live = (this.totalCoins || 0) + (this.sessionCoins || 0);
    this.ui.coins.textContent = `COINS:${live}`;
  }
}

// ============= INIT =============
const game = new Game();
game.updateUI();

// (Equip controls moved into the Shop -> Owned tab)

// ============= SCREEN NAVIGATION =============
const homeScreen = document.getElementById('homeScreen');
const gameScreen = document.getElementById('gameScreen');
const shopScreen = document.getElementById('shopScreen');
const extraScreen = document.getElementById('extraScreen');

// ======= SHOP / OWNED HELPERS =======
function isOwned(key) {
  return localStorage.getItem('own_' + key) === 'true';
}

function buyItem(key, price) {
  if (isOwned(key)) { alert('You already own this item.'); return; }
  if (game.totalCoins < price) { alert('Not enough coins.'); return; }
  game.totalCoins -= price;
  localStorage.setItem('duckCoins', game.totalCoins.toString());
  localStorage.setItem('own_' + key, 'true');
  // special flags for known items
  if (key === 'duck_gold') {
    localStorage.setItem('duckSkinUnlocked', 'true');
    game.duckSkinUnlocked = true;
  } else if (key === 'bg_night') {
    // mark night background owned
    localStorage.setItem('bg_night_owned', 'true');
  }
  game.updateUI();
  renderShop();
  renderOwned();
  alert('Purchase successful! Check Owned tab to equip.');
}

function renderShop() {
  // update buy buttons / disabled state
  const priceDuck = CONFIG.duckSkinPrice;
  const buyDuck = document.getElementById('buyDuckBtn');
  if (isOwned('duck_gold')) {
    buyDuck.textContent = 'OWNED'; buyDuck.disabled = true; buyDuck.style.opacity = '0.6';
  } else if (game.totalCoins >= priceDuck) {
    buyDuck.textContent = `BUY ${priceDuck}`; buyDuck.disabled = false; buyDuck.style.opacity = '1';
  } else {
    buyDuck.textContent = `BUY ${priceDuck}`; buyDuck.disabled = false; buyDuck.style.opacity = '0.6';
  }
  const buyBg = document.getElementById('buyBgBtn');
  if (isOwned('bg_sunset')) { buyBg.textContent = 'OWNED'; buyBg.disabled = true; buyBg.style.opacity = '0.6'; }
  else if (game.totalCoins >= 300) { buyBg.textContent = 'BUY 300'; buyBg.disabled = false; buyBg.style.opacity = '1'; }
  else { buyBg.textContent = 'BUY 300'; buyBg.disabled = false; buyBg.style.opacity = '0.6'; }
  const buySpace = document.getElementById('buySpaceBtn');
  if (isOwned('bg_space')) { buySpace.textContent = 'OWNED'; buySpace.disabled = true; buySpace.style.opacity = '0.6'; }
  else if (game.totalCoins >= 400) { buySpace.textContent = 'BUY 400'; buySpace.disabled = false; buySpace.style.opacity = '1'; }
  else { buySpace.textContent = 'BUY 400'; buySpace.disabled = false; buySpace.style.opacity = '0.6'; }

  // additional backgrounds
  const buyVolcano = document.getElementById('buyVolcanoBtn');
  if (buyVolcano) {
    if (isOwned('bg_volcano')) { buyVolcano.textContent = 'OWNED'; buyVolcano.disabled = true; buyVolcano.style.opacity = '0.6'; }
    else if (game.totalCoins >= 350) { buyVolcano.textContent = 'BUY 350'; buyVolcano.disabled = false; buyVolcano.style.opacity = '1'; }
    else { buyVolcano.textContent = 'BUY 350'; buyVolcano.disabled = false; buyVolcano.style.opacity = '0.6'; }
  }
  const buyNeon = document.getElementById('buyNeonBtn');
  if (buyNeon) {
    if (isOwned('bg_neon')) { buyNeon.textContent = 'OWNED'; buyNeon.disabled = true; buyNeon.style.opacity = '0.6'; }
    else if (game.totalCoins >= 300) { buyNeon.textContent = 'BUY 300'; buyNeon.disabled = false; buyNeon.style.opacity = '1'; }
    else { buyNeon.textContent = 'BUY 300'; buyNeon.disabled = false; buyNeon.style.opacity = '0.6'; }
  }
  const buyForest = document.getElementById('buyForestBtn');
  if (buyForest) {
    if (isOwned('bg_forest')) { buyForest.textContent = 'OWNED'; buyForest.disabled = true; buyForest.style.opacity = '0.6'; }
    else if (game.totalCoins >= 200) { buyForest.textContent = 'BUY 200'; buyForest.disabled = false; buyForest.style.opacity = '1'; }
    else { buyForest.textContent = 'BUY 200'; buyForest.disabled = false; buyForest.style.opacity = '0.6'; }
  }
  

  // additional duck skins
  const buyPirate = document.getElementById('buyDuckPirateBtn');
  if (buyPirate) {
    if (isOwned('duck_pirate')) { buyPirate.textContent = 'OWNED'; buyPirate.disabled = true; buyPirate.style.opacity = '0.6'; }
    else if (game.totalCoins >= 300) { buyPirate.textContent = 'BUY 300'; buyPirate.disabled = false; buyPirate.style.opacity = '1'; }
    else { buyPirate.textContent = 'BUY 300'; buyPirate.disabled = false; buyPirate.style.opacity = '0.6'; }
  }
  const buyRobot = document.getElementById('buyDuckRobotBtn');
  if (buyRobot) {
    if (isOwned('duck_robot')) { buyRobot.textContent = 'OWNED'; buyRobot.disabled = true; buyRobot.style.opacity = '0.6'; }
    else if (game.totalCoins >= 350) { buyRobot.textContent = 'BUY 350'; buyRobot.disabled = false; buyRobot.style.opacity = '1'; }
    else { buyRobot.textContent = 'BUY 350'; buyRobot.disabled = false; buyRobot.style.opacity = '0.6'; }
  }
  const buyNinja = document.getElementById('buyDuckNinjaBtn');
  if (buyNinja) {
    if (isOwned('duck_ninja')) { buyNinja.textContent = 'OWNED'; buyNinja.disabled = true; buyNinja.style.opacity = '0.6'; }
    else if (game.totalCoins >= 250) { buyNinja.textContent = 'BUY 250'; buyNinja.disabled = false; buyNinja.style.opacity = '1'; }
    else { buyNinja.textContent = 'BUY 250'; buyNinja.disabled = false; buyNinja.style.opacity = '0.6'; }
  }
  const buyAstronaut = document.getElementById('buyDuckAstronautBtn');
  if (buyAstronaut) {
    if (isOwned('duck_astronaut')) { buyAstronaut.textContent = 'OWNED'; buyAstronaut.disabled = true; buyAstronaut.style.opacity = '0.6'; }
    else if (game.totalCoins >= 400) { buyAstronaut.textContent = 'BUY 400'; buyAstronaut.disabled = false; buyAstronaut.style.opacity = '1'; }
    else { buyAstronaut.textContent = 'BUY 400'; buyAstronaut.disabled = false; buyAstronaut.style.opacity = '0.6'; }
  }

  
}

function renderOwned() {
  const od = document.getElementById('ownedDucks');
  const ob = document.getElementById('ownedBgs');
  od.innerHTML = '';
  ob.innerHTML = '';

  // Ducks: always show Default
  const defaultDuckRow = document.createElement('div');
  defaultDuckRow.style.display = 'flex';
  defaultDuckRow.style.gap = '8px';
  defaultDuckRow.style.alignItems = 'center';
  const defLabel = document.createElement('div'); defLabel.textContent = 'Default';
  const defBtn = document.createElement('button');
  defBtn.className = 'shop-btn';
  defBtn.textContent = (game.equippedSkin === null) ? 'EQUIPPED' : 'EQUIP';
  defBtn.onclick = () => { game.equippedSkin = null; localStorage.setItem('duckEquipped', ''); defBtn.textContent = 'EQUIPPED'; renderOwned(); };
  defaultDuckRow.appendChild(defLabel);
  defaultDuckRow.appendChild(defBtn);
  od.appendChild(defaultDuckRow);

  // Gold duck
  if (isOwned('duck_gold')) {
    const row = document.createElement('div'); row.style.display = 'flex'; row.style.gap = '8px'; row.style.alignItems = 'center';
    const label = document.createElement('div'); label.textContent = 'Gold';
    const btn = document.createElement('button'); btn.className = 'shop-btn';
    btn.textContent = (game.equippedSkin === 'gold') ? 'UNEQUIP' : 'EQUIP';
    btn.onclick = () => { game.equippedSkin = (game.equippedSkin === 'gold') ? null : 'gold'; localStorage.setItem('duckEquipped', game.equippedSkin || ''); renderOwned(); };
    row.appendChild(label); row.appendChild(btn); od.appendChild(row);
  }

  // Pirate duck
  if (isOwned('duck_pirate')) {
    const row = document.createElement('div'); row.style.display = 'flex'; row.style.gap = '8px'; row.style.alignItems = 'center';
    const label = document.createElement('div'); label.textContent = 'Pirate';
    const btn = document.createElement('button'); btn.className = 'shop-btn';
    btn.textContent = (game.equippedSkin === 'pirate') ? 'UNEQUIP' : 'EQUIP';
    btn.onclick = () => { game.equippedSkin = (game.equippedSkin === 'pirate') ? null : 'pirate'; localStorage.setItem('duckEquipped', game.equippedSkin || ''); renderOwned(); };
    row.appendChild(label); row.appendChild(btn); od.appendChild(row);
  }

  // Robot duck
  if (isOwned('duck_robot')) {
    const row = document.createElement('div'); row.style.display = 'flex'; row.style.gap = '8px'; row.style.alignItems = 'center';
    const label = document.createElement('div'); label.textContent = 'Robot';
    const btn = document.createElement('button'); btn.className = 'shop-btn';
    btn.textContent = (game.equippedSkin === 'robot') ? 'UNEQUIP' : 'EQUIP';
    btn.onclick = () => { game.equippedSkin = (game.equippedSkin === 'robot') ? null : 'robot'; localStorage.setItem('duckEquipped', game.equippedSkin || ''); renderOwned(); };
    row.appendChild(label); row.appendChild(btn); od.appendChild(row);
  }

  // Ninja duck
  if (isOwned('duck_ninja')) {
    const row = document.createElement('div'); row.style.display = 'flex'; row.style.gap = '8px'; row.style.alignItems = 'center';
    const label = document.createElement('div'); label.textContent = 'Ninja';
    const btn = document.createElement('button'); btn.className = 'shop-btn';
    btn.textContent = (game.equippedSkin === 'ninja') ? 'UNEQUIP' : 'EQUIP';
    btn.onclick = () => { game.equippedSkin = (game.equippedSkin === 'ninja') ? null : 'ninja'; localStorage.setItem('duckEquipped', game.equippedSkin || ''); renderOwned(); };
    row.appendChild(label); row.appendChild(btn); od.appendChild(row);
  }


  // Astronaut duck
  if (isOwned('duck_astronaut')) {
    const row = document.createElement('div'); row.style.display = 'flex'; row.style.gap = '8px'; row.style.alignItems = 'center';
    const label = document.createElement('div'); label.textContent = 'Astronaut';
    const btn = document.createElement('button'); btn.className = 'shop-btn';
    btn.textContent = (game.equippedSkin === 'astronaut') ? 'UNEQUIP' : 'EQUIP';
    btn.onclick = () => { game.equippedSkin = (game.equippedSkin === 'astronaut') ? null : 'astronaut'; localStorage.setItem('duckEquipped', game.equippedSkin || ''); renderOwned(); };
    row.appendChild(label); row.appendChild(btn); od.appendChild(row);
  }

  // Zombie duck (unlocked by shooting sun)
  if (isOwned('duck_zombie')) {
    const row = document.createElement('div'); row.style.display = 'flex'; row.style.gap = '8px'; row.style.alignItems = 'center';
    const label = document.createElement('div'); label.textContent = 'Zombie';
    const btn = document.createElement('button'); btn.className = 'shop-btn';
    btn.textContent = (game.equippedSkin === 'zombie') ? 'UNEQUIP' : 'EQUIP';
    btn.onclick = () => { game.equippedSkin = (game.equippedSkin === 'zombie') ? null : 'zombie'; localStorage.setItem('duckEquipped', game.equippedSkin || ''); renderOwned(); };
    row.appendChild(label); row.appendChild(btn); od.appendChild(row);
  }

  // Backgrounds: Default
  const defaultBgRow = document.createElement('div'); defaultBgRow.style.display = 'flex'; defaultBgRow.style.gap = '8px'; defaultBgRow.style.alignItems = 'center';
  const bgLabel = document.createElement('div'); bgLabel.textContent = 'Default';
  const bgBtn = document.createElement('button'); bgBtn.className = 'shop-btn'; bgBtn.textContent = (game.bgEquipped === null) ? 'EQUIPPED' : 'EQUIP';
  bgBtn.onclick = () => { game.bgEquipped = null; localStorage.setItem('bgEquipped',''); renderOwned(); };
  defaultBgRow.appendChild(bgLabel); defaultBgRow.appendChild(bgBtn); ob.appendChild(defaultBgRow);

  if (isOwned('bg_sunset')) {
    const row = document.createElement('div'); row.style.display = 'flex'; row.style.gap = '8px'; row.style.alignItems = 'center';
    const label = document.createElement('div'); label.textContent = 'Sunset';
    const btn = document.createElement('button'); btn.className = 'shop-btn';
    btn.textContent = (game.bgEquipped === 'sunset') ? 'UNEQUIP' : 'EQUIP';
    btn.onclick = () => { game.bgEquipped = (game.bgEquipped === 'sunset') ? null : 'sunset'; localStorage.setItem('bgEquipped', game.bgEquipped || ''); renderOwned(); };
    row.appendChild(label); row.appendChild(btn); ob.appendChild(row);
  }

  if (isOwned('bg_volcano')) {
    const row = document.createElement('div'); row.style.display = 'flex'; row.style.gap = '8px'; row.style.alignItems = 'center';
    const label = document.createElement('div'); label.textContent = 'Volcano';
    const btn = document.createElement('button'); btn.className = 'shop-btn';
    btn.textContent = (game.bgEquipped === 'volcano') ? 'UNEQUIP' : 'EQUIP';
    btn.onclick = () => { game.bgEquipped = (game.bgEquipped === 'volcano') ? null : 'volcano'; localStorage.setItem('bgEquipped', game.bgEquipped || ''); renderOwned(); };
    row.appendChild(label); row.appendChild(btn); ob.appendChild(row);
  }

  if (isOwned('bg_neon')) {
    const row = document.createElement('div'); row.style.display = 'flex'; row.style.gap = '8px'; row.style.alignItems = 'center';
    const label = document.createElement('div'); label.textContent = 'Neon City';
    const btn = document.createElement('button'); btn.className = 'shop-btn';
    btn.textContent = (game.bgEquipped === 'neon') ? 'UNEQUIP' : 'EQUIP';
    btn.onclick = () => { game.bgEquipped = (game.bgEquipped === 'neon') ? null : 'neon'; localStorage.setItem('bgEquipped', game.bgEquipped || ''); renderOwned(); };
    row.appendChild(label); row.appendChild(btn); ob.appendChild(row);
  }

  if (isOwned('bg_forest')) {
    const row = document.createElement('div'); row.style.display = 'flex'; row.style.gap = '8px'; row.style.alignItems = 'center';
    const label = document.createElement('div'); label.textContent = 'Forest';
    const btn = document.createElement('button'); btn.className = 'shop-btn';
    btn.textContent = (game.bgEquipped === 'forest') ? 'UNEQUIP' : 'EQUIP';
    btn.onclick = () => { game.bgEquipped = (game.bgEquipped === 'forest') ? null : 'forest'; localStorage.setItem('bgEquipped', game.bgEquipped || ''); renderOwned(); };
    row.appendChild(label); row.appendChild(btn); ob.appendChild(row);
  }

  if (isOwned('bg_space')) {
    const row = document.createElement('div'); row.style.display = 'flex'; row.style.gap = '8px'; row.style.alignItems = 'center';
    const label = document.createElement('div'); label.textContent = 'Space (Moon)';
    const btn = document.createElement('button'); btn.className = 'shop-btn';
    btn.textContent = (game.bgEquipped === 'space') ? 'UNEQUIP' : 'EQUIP';
    btn.onclick = () => { game.bgEquipped = (game.bgEquipped === 'space') ? null : 'space'; localStorage.setItem('bgEquipped', game.bgEquipped || ''); renderOwned(); };
    row.appendChild(label); row.appendChild(btn); ob.appendChild(row);
  }
}

function showScreen(screen) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  screen.classList.add('active');
  if (screen === gameScreen) {
    setTimeout(() => game.resizeCanvas(), 10);
  }
}

document.getElementById('playBtn').addEventListener('click', () => {
  showScreen(gameScreen);
  setTimeout(() => {
    const modal = document.getElementById('instructionsModal');
    modal.classList.add('active');
  }, 50);
});

document.getElementById('startGameBtn').addEventListener('click', () => {
  const modal = document.getElementById('instructionsModal');
  modal.classList.remove('active');
  if (!game.running) {
    game.start();
  }
});

document.getElementById('shopBtn').addEventListener('click', () => {
  showScreen(shopScreen);
  renderShop();
  renderOwned();

  // tabs
  document.getElementById('shopTabBtn').onclick = () => {
    document.getElementById('shopList').style.display = '';
    document.getElementById('ownedList').style.display = 'none';
  };
  document.getElementById('ownedTabBtn').onclick = () => {
    document.getElementById('shopList').style.display = 'none';
    document.getElementById('ownedList').style.display = '';
    renderOwned();
  };

  // buy handlers
  const buyDuck = document.getElementById('buyDuckBtn');
  const buyBg = document.getElementById('buyBgBtn');
  const buySpace = document.getElementById('buySpaceBtn');
  if (buyDuck) buyDuck.onclick = () => buyItem('duck_gold', CONFIG.duckSkinPrice);
  if (buyBg) buyBg.onclick = () => buyItem('bg_sunset', 300);
  if (buySpace) buySpace.onclick = () => buyItem('bg_space', 400);
  const buyPirate = document.getElementById('buyDuckPirateBtn');
  const buyRobot = document.getElementById('buyDuckRobotBtn');
  const buyNinja = document.getElementById('buyDuckNinjaBtn');
  const buyRainbow = document.getElementById('buyDuckRainbowBtn');
  const buyAstronaut = document.getElementById('buyDuckAstronautBtn');
  const buyVolcano = document.getElementById('buyVolcanoBtn');
  const buyNeon = document.getElementById('buyNeonBtn');
  const buyForest = document.getElementById('buyForestBtn');
  if (buyPirate) buyPirate.onclick = () => buyItem('duck_pirate', 300);
  if (buyRobot) buyRobot.onclick = () => buyItem('duck_robot', 350);
  if (buyNinja) buyNinja.onclick = () => buyItem('duck_ninja', 250);
  if (buyRainbow) buyRainbow.onclick = () => buyItem('duck_rainbow', 450);
  if (buyAstronaut) buyAstronaut.onclick = () => buyItem('duck_astronaut', 400);
  if (buyVolcano) buyVolcano.onclick = () => buyItem('bg_volcano', 350);
  if (buyNeon) buyNeon.onclick = () => buyItem('bg_neon', 300);
  if (buyForest) buyForest.onclick = () => buyItem('bg_forest', 200);
});

document.getElementById('extraBtn').addEventListener('click', () => {
  // populate Extra stats
  const highestWave = parseInt(localStorage.getItem('highestWave')) || 0;
  const gamesPlayed = parseInt(localStorage.getItem('gamesPlayed')) || 0;
  const totalDucks = parseInt(localStorage.getItem('totalDucks')) || 0;
  const hwEl = document.getElementById('highestWave');
  const gpEl = document.getElementById('gamesPlayed');
  const tdEl = document.getElementById('totalDucks');
  if (hwEl) hwEl.textContent = highestWave;
  if (gpEl) gpEl.textContent = gamesPlayed;
  if (tdEl) tdEl.textContent = totalDucks;
  showScreen(extraScreen);
});

document.getElementById('homeBtn').addEventListener('click', () => {
  game.reset();
  showScreen(homeScreen);
});

document.getElementById('backFromShopBtn').addEventListener('click', () => {
  showScreen(homeScreen);
});

document.getElementById('backFromExtraBtn').addEventListener('click', () => {
  showScreen(homeScreen);
});

// Game Over overlay handlers
document.getElementById('retryBtn').addEventListener('click', () => {
  const overlay = document.getElementById('gameOverOverlay');
  overlay.classList.remove('show');
  game.reset();
  if (!game.running) {
    game.start();
  }
});

document.getElementById('homeFromGameOverBtn').addEventListener('click', () => {
  const overlay = document.getElementById('gameOverOverlay');
  overlay.classList.remove('show');
  game.reset();
  showScreen(homeScreen);
});</script>
</body>
</html>
